rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users Collection Rules
    match /users/{userId} {
      // Anyone can read user profiles (public access for viewing author info and published articles)
      allow read: if true;
      
      // Users can create their own profile only during signup
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['fullName', 'email', 'bio', 'photoUrl', 'createdAt'])
        && request.resource.data.email is string
        && request.resource.data.fullName is string;
      
      // Users can update only their own profile
      allow update: if isOwner(userId)
        && request.resource.data.email == resource.data.email; // Email cannot be changed
      
      // Users cannot delete their profiles (soft delete would be handled in app logic)
      allow delete: if false;
    }
    
    // Articles Collection Rules
    match /articles/{articleId} {
      // Anyone can read articles (public access)
      allow read: if true;
      
      // Only authenticated users can create articles
      // Article must have required fields and userId must match authenticated user
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.userId is string
        && request.resource.data.title is string;
      
      // Users can update their own articles
      // Users can also like/unlike articles (modifying likes array)
      allow update: if isAuthenticated()
        && (
          // User owns the article and can update most fields
          (resource.data.userId == request.auth.uid 
            && request.resource.data.userId == resource.data.userId // Cannot change ownership
            && request.resource.data.publishedAt == resource.data.publishedAt) // Cannot change publish date
          ||
          // Anyone can update likes array (for like/unlike functionality)
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
            && request.resource.data.likes is list)
        );
      
      // Only article owner can delete their articles
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}